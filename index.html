
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Выбор профессии</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #1f2937, #111827);
    color: white;
    margin: 0;
    padding: 20px;
}

h1 {
    text-align: center;
    margin-bottom: 5px;
}

.grid {
    display: grid;
    gap: 10px;
    justify-content: center;
}

.row-12 {
    grid-template-columns: repeat(12, 110px);
}

.row-9 {
    grid-template-columns: repeat(9, 110px);
    margin-top: 15px;
}

.card {
    height: 140px;
    color: white;
    text-shadow: 1px 1px 2px #000;
    border-radius: 14px;
    padding: 10px;
    font-size: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    cursor: grab;
    position: relative;
    box-shadow: 0 6px 15px rgba(0,0,0,0.4);
    transition: transform 0.3s ease;
    touch-action: none; /* Prevent default touch behaviors */
}

.card:hover {
    transform: scale(1.05);
}

.rank {
    position: absolute;
    top: 6px;
    left: 8px;
    font-size: 11px;
    font-weight: bold;
    color: #ccc;
}

.code {
    font-weight: bold;
}

.dragging {
    opacity: 0.5;
}

.info-panel {
    text-align: center;
    margin-bottom: 20px;
}

input {
    padding: 8px;
    border-radius: 6px;
    border: none;
    width: 200px;
    margin-right: 10px;
}

/* Mobile adaptations */
@media (max-width: 768px) {
    .grid {
        grid-template-columns: 1fr; /* Single column for mobile */
        justify-items: center;
    }

    .row-12, .row-9 {
        grid-template-columns: 1fr;
    }

    .card {
        width: 100%;
        max-width: 300px; /* Limit card width on small screens */
        height: auto;
        min-height: 100px;
        padding: 15px;
        font-size: 14px; /* Slightly larger text for touch */
    }

    body {
        padding: 10px;
    }

    input {
        width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
    }
}
</style>
</head>

<body>

<h1>Выбор профессии</h1>

<p style="text-align: center; margin-bottom: 20px;">Проранжируй каждый список в порядке значимости</p>

<div class="info-panel">
    <input type="text" id="participantName" placeholder="Имя участника">
</div>

<div id="container"></div>

<button onclick="exportPDF()" style="display: block; margin: 20px auto; background: #3b82f6; border: none; padding: 10px 20px; border-radius: 8px; color: white; font-size: 14px; cursor: pointer;">Экспорт в PDF</button>

<script>
const { jsPDF } = window.jspdf;
const container = document.getElementById("container");

// === Карточки ===
let cards = [
"Ценность 1 - Спокойная жизнь: семья, собственное жильё, стабильность",
"Ценность 2 - Многодетность и родственные связи: дети, родня, широкий круг знакомых, крупное хозяйство",
"Ценность 3 - Служение идее: научные, духовные или эстетические искания, мировоззренческая борьба",
"Ценность 4 - Материальное благополучие, социальные контакты, престиж, предпринимательские и финансовые риски",
"Ценность 5 - Наслаждение жизнью: досуг, поездки, дружеское общение",
"Ценность 6 - Удовольствие от обучения: приобщение к научным, духовным и культурным ценностям",
"Ценность 7 - Ориентация на здоровье и внешнюю привлекательность",
"Ценность 8 - Доминирование, авторитет, публичная известность",
"Ценность 9 - Самоуглубление, уединённость, интерес к мистике и философским размышлениям",
"Ценность 10 - Существование за счёт пассивного дохода",
"Ценность 11 - Успех через окружение: деятельность и связи с обеспеченными и влиятельными персонами",
"Ценность 12 - Инвестиции в личностный и детский рост: освоение новых компетенций, раскрытие способностей",
"ПТ-1 Технические устройства",
"ПТ-2 Данные из природных и технических источников (тексты, измерения приборов, документация, программные продукты)",
"ПТ-3 Общественные структуры",
"ПТ-4 Эмоционально-художественная сфера: чувства, впечатления, инсайты, образы",
"ПТ-5 Научные знания и концептуальные системы",
"ПТ-6 Биологический мир (животные, птицы, рыбы, насекомые, растения и др.)",
"ПТ-7 Взрослые люди и представители фауны",
"ПТ-8 Несовершеннолетние: дети и подростки",
"ПТ-9 Компоненты, сырьевые ресурсы и материалы для обработки",
"ЦТ-1 Анализировать, инспектировать, осуществлять надзор",
"ЦT-2 Осуществлять торговые операции: реализовывать, приобретать, выступать посредником",
"ЦТ-3 Перевозить: доставлять людей и объекты",
"ЦТ-4 Модифицировать материалы, физические и цифровые объекты, сведения",
"ЦТ-5 Воздействовать на мышление и мировоззрение людей",
"ЦТ-6 Созидать, разрабатывать, генерировать новое",
"ЦТ-7 Координировать коллектив, управлять процессами",
"ЦТ-8 Предоставлять сервис",
"ЦТ-9 Самосовершенствоваться, поддерживать физическую форму",
"СТ-1 Ручные навыки (инструменты, приборы, мастерство)",
"СТ-2 Механизированные средства (оборудование, машины, технические агрегаты)",
"СТ-3 Программно управляемые системы",
"СТ-4 Вычислительная техника",
"СТ-5 Интеллектуальный багаж, когнитивные стратегии, память",
"СТ-6 Пластика и мимика (умение располагать к себе, внушать доверие)",
"СТ-7 Креативное мышление, нестандартный подход, оригинальная позиция",
"СТ-8 Физические ресурсы организма и чувствительность (острое зрение, слух и др.)",
"СТ-9 Речевые данные",
"УТ-1 Офисная среда (кабинет, отдел, рабочее помещение)",
"УТ-2 Пространство с присутствием людей (магазинный зал, сцена, аудитория)",
"УТ-3 Постоянные поездки, служебные командировки",
"УТ-4 Частичная автономия (самостоятельное принятие решений в рамках задачи)",
"УТ-5 Деятельность на открытом пространстве",
"УТ-6 Экстремальные или сложные условия (в воздухе, под водой, в шахтах, в боевых зонах и т.д.)",
"УТ-7 Особый режим работы (стерильность, определённая температура, влажность)",
"УТ-8 Элитные контакты, статусное окружение",
"УТ-9 Высокооплачиваемый труд, социальные бонусы",
"ДУТ-1 Добросовестная деятельность",
"ДУТ-2 Безопасная профессия с умеренной нагрузкой",
"ДУТ-3 Свободный формат труда: гибкий график, отсутствие строгого дресс-кода, открытое общение",
"ДУТ-4 Осознание значимости работы, высокая степень ответственности (финансовой, моральной, за безопасность людей)",
"ДУТ-5 Драйв, рискованные ситуации, элемент азарта",
"ДУТ-6 Дополнительные источники дохода (бонусы, чаевые, подарки)",
"ДУТ-7 Размеренная, спокойная деятельность",
"ДУТ-8 Статусная занятость: признание, уважение, самоутверждение",
"ДУТ-9 Динамичная работа без статичности",
"КТ-1 Самостоятельная деятельность с минимальными контактами",
"КТ-2 Стандартный рабочий коллектив",
"КТ-3 Работа с аудиториями (образовательными, театральными, спортивными и др.)",
"КТ-4 Взаимодействие с клиентами и посетителями — регулярно сменяющийся поток людей",
"КТ-5 Чёткая иерархия, дисциплина, регламентированные обязанности",
"КТ-6 Публичная деятельность, работа на виду у окружающих",
"КТ-7 Онлайн-коммуникация, удалённое взаимодействие",
"КТ-8 Малочисленная команда в ограниченном пространстве",
"КТ-9 Эпизодическое взаимодействие через обращение к духовному и культурному наследию посредством собственных произведений",
];

const groups = [
  { label: "Ценности", cards: cards.slice(0, 12), colorDark: "#001f3f", colorLight: "#add8e6" },
  { label: "Предметы труда", cards: cards.slice(12, 21), colorDark: "#006400", colorLight: "#90ee90" },
  { label: "Цели труда", cards: cards.slice(21, 30), colorDark: "#8b0000", colorLight: "#ffcccb" },
  { label: "Средства труда", cards: cards.slice(30, 39), colorDark: "#4b0082", colorLight: "#dda0dd" },
  { label: "Условия труда", cards: cards.slice(39, 48), colorDark: "#ff8c00", colorLight: "#ffe4b5" },
  { label: "Доп.условия труда", cards: cards.slice(48, 57), colorDark: "#556b2f", colorLight: "#bdb76b" },
  { label: "Коммуникации труда", cards: cards.slice(57, 66), colorDark: "#2f4f4f", colorLight: "#d3d3d3" }
];

function interpolateColor(color1, color2, factor) {
  let result = "#";
  for (let i = 0; i < 3; i++) {
    let c1 = parseInt(color1.substr(1 + i * 2, 2), 16);
    let c2 = parseInt(color2.substr(1 + i * 2, 2), 16);
    let val = Math.round(c1 + factor * (c2 - c1));
    result += val.toString(16).padStart(2, "0");
  }
  return result;
}

function renderCards() {
  container.innerHTML = "";

  groups.forEach((group, groupIndex) => {
    let labelElem = document.createElement("h2");
    labelElem.textContent = group.label;
    labelElem.style.textAlign = "center";
    container.appendChild(labelElem);

    let row = document.createElement("div");
    row.className = "grid " + (groupIndex === 0 ? "row-12" : "row-9");
    group.cards.forEach((text, index) => {
      createCard(row, text, group, index, group.cards.length);
    });
    container.appendChild(row);
  });

  updateRanks();
}

function createCard(parent, text, group, index, length) {
  const card = document.createElement("div");
  card.className = "card";
  card.draggable = true;

  const codeMatch = text.match(/^[\u0410-\u042F\u0041-\u005A]+-\d+/);
  const code = codeMatch ? codeMatch[0] : '';
  const description = text.replace(code + ' ', '');

  card.innerHTML = `<div class="rank"></div><span class="code">${code}</span><br>${description}`;

  const factor = length > 1 ? index / (length - 1) : 0;
  const bgColor = interpolateColor(group.colorDark, group.colorLight, factor);
  card.style.background = bgColor;

  // Desktop drag events
  card.addEventListener("dragstart", dragStart);
  card.addEventListener("dragend", dragEnd);

  // Touch events for mobile
  card.addEventListener("touchstart", touchStart, { passive: false });
  card.addEventListener("touchmove", touchMove, { passive: false });
  card.addEventListener("touchend", touchEnd);

  parent.appendChild(card);
}

// Drag functions for desktop
function dragStart(e) {
  this.classList.add("dragging");
  this.style.visibility = 'hidden';
  e.dataTransfer.setData("text/plain", ""); // Required for Firefox
}

function dragEnd() {
  this.classList.remove("dragging");
  this.style.visibility = '';
  updateOrder();
  updateRanks();
}

// Touch variables
let touchMoved = false;
let touchElem = null;
let initialX = 0;
let initialY = 0;
let ghostElem = null;
let lastClientX = 0;
let lastClientY = 0;
let isDragging = false;

// Touch functions for mobile
function touchStart(e) {
  if (e.touches.length !== 1) return;
  touchElem = this;
  touchMoved = false;
  initialX = e.touches[0].clientX - this.getBoundingClientRect().left;
  initialY = e.touches[0].clientY - this.getBoundingClientRect().top;
  lastClientX = e.touches[0].clientX;
  lastClientY = e.touches[0].clientY;
  this.classList.add("dragging");
  this.style.visibility = 'hidden';

  // Create ghost element for visual feedback
  ghostElem = this.cloneNode(true);
  ghostElem.style.position = "absolute";
  ghostElem.style.zIndex = 1000;
  ghostElem.style.opacity = 0.5;
  ghostElem.classList.remove("dragging");
  document.body.appendChild(ghostElem);
  moveGhost(e.touches[0]);

  isDragging = true;
  requestAnimationFrame(autoScroll);
}

function touchMove(e) {
  if (!touchElem || e.touches.length !== 1) return;
  e.preventDefault();
  touchMoved = true;
  lastClientX = e.touches[0].clientX;
  lastClientY = e.touches[0].clientY;
  moveGhost(e.touches[0]);

  const clientX = e.touches[0].clientX;
  const clientY = e.touches[0].clientY;
  reorderWithAnimation(touchElem, clientX, clientY);
}

function touchEnd(e) {
  if (!touchElem) return;
  if (ghostElem) {
    document.body.removeChild(ghostElem);
    ghostElem = null;
  }
  touchElem.classList.remove("dragging");
  touchElem.style.visibility = '';
  if (touchMoved) {
    updateOrder();
    updateRanks();
  }
  isDragging = false;
  touchElem = null;
}

function moveGhost(touch) {
  if (ghostElem) {
    ghostElem.style.left = `${touch.clientX - initialX}px`;
    ghostElem.style.top = `${touch.clientY - initialY}px`;
  }
}

function autoScroll() {
  if (!isDragging) return;

  const viewportHeight = window.innerHeight;
  const touchY = lastClientY;
  let scrollAmount = 0;
  const edgeSize = 100;
  const maxSpeed = 30;

  if (touchY < edgeSize) {
    scrollAmount = -((edgeSize - touchY) / edgeSize * maxSpeed);
  } else if (touchY > viewportHeight - edgeSize) {
    scrollAmount = ((touchY - (viewportHeight - edgeSize)) / edgeSize * maxSpeed);
  }

  if (scrollAmount !== 0) {
    window.scrollBy(0, scrollAmount);
    reorderWithAnimation(touchElem, lastClientX, lastClientY);
    touchMoved = true;
  }

  requestAnimationFrame(autoScroll);
}

// Dragover for desktop
document.addEventListener("dragover", e => {
  e.preventDefault();
  const dragging = document.querySelector(".dragging");
  if (!dragging) return;

  const clientX = e.clientX;
  const clientY = e.clientY;
  reorderWithAnimation(dragging, clientX, clientY);
});

// Reorder with animation function
function reorderWithAnimation(dragging, clientX, clientY) {
  const srcRow = dragging.parentElement;
  const targetGrid = dragging.parentElement; // Assume same grid, as cross not allowed

  if (!targetGrid) return;

  // Get current cards except dragging
  const cardsDOM = [...targetGrid.children].filter(c => c !== dragging && c.classList.contains('card'));
  const cards = cardsDOM.map(c => ({card: c, rect: c.getBoundingClientRect()}));

  // Record old rects
  const oldRects = cards.map(({card, rect}) => ({card, rect}));

  // Determine if horizontal or vertical
  const firstTwo = cards.slice(0, 2);
  const isHorizontal = firstTwo.length < 2 || Math.abs(firstTwo[0].rect.top - firstTwo[1].rect.top) < 1;

  // Find nextCard
  const nextCard = cards.find(({card, rect}) => {
    return isHorizontal ? clientX <= rect.left + rect.width / 2 : clientY <= rect.top + rect.height / 2;
  })?.card || null;

  // Reorder
  if (nextCard) {
    targetGrid.insertBefore(dragging, nextCard);
  } else {
    targetGrid.appendChild(dragging);
  }

  // Now animate the non-dragging cards
  oldRects.forEach(({card, rect}) => {
    const newRect = card.getBoundingClientRect();
    const deltaX = rect.left - newRect.left;
    const deltaY = rect.top - newRect.top;

    card.style.transition = 'none';
    card.style.transform = `translate(${deltaX}px, ${deltaY}px)`;

    requestAnimationFrame(() => {
      card.style.transition = 'transform 0.3s ease';
      card.style.transform = '';
    });
  });
}

function updateOrder() {
  const rows = container.querySelectorAll(".grid");
  groups.forEach((group, gIdx) => {
    const row = rows[gIdx];
    const allCardsInRow = row.querySelectorAll(".card");
    group.cards = Array.from(allCardsInRow).map(card => {
      const code = card.querySelector(".code").textContent;
      const description = card.innerText.replace(/^#\d+\s*/, '').replace(code, '').trim().replace(/^\s*/, '');
      return `${code} ${description}`;
    });
  });
}

function updateRanks() {
  const rows = container.querySelectorAll(".grid");
  rows.forEach(row => {
    const cardsInRow = row.querySelectorAll(".card");
    cardsInRow.forEach((card, idx) => {
      card.querySelector(".rank").innerText = "#" + (idx + 1);
    });
  });
}

function exportPDF() {
  const name = document.getElementById("participantName").value.trim() || "default";
  const fileName = `${name}-professions-ranking.pdf`;

  const tempContainer = document.createElement('div');
  tempContainer.style.position = 'absolute';
  tempContainer.style.left = '-9999px';
  tempContainer.style.background = 'linear-gradient(135deg, #1f2937, #111827)';
  tempContainer.style.padding = '20px';
  tempContainer.style.color = 'white';
  tempContainer.style.width = '360px'; // To keep card sizes unchanged by constraining the container
  document.body.appendChild(tempContainer);

  const title = document.createElement('h1');
  title.textContent = 'Выбор профессии';
  title.style.textAlign = 'center';
  tempContainer.appendChild(title);

  const instruction = document.createElement('p');
  instruction.textContent = 'Проранжируй каждый список в порядке значимости';
  instruction.style.textAlign = 'center';
  instruction.style.marginBottom = '20px';
  tempContainer.appendChild(instruction);

  const rows = container.querySelectorAll('.grid');
  groups.forEach((group, gIdx) => {
    const labelElem = document.createElement("h2");
    labelElem.textContent = group.label;
    labelElem.style.textAlign = "center";
    tempContainer.appendChild(labelElem);

    const row = rows[gIdx];
    const cardsInRow = row.querySelectorAll(".card");
    const top3Cards = Array.from(cardsInRow).slice(0, 3);

    const tempRow = document.createElement("div");
    tempRow.className = "grid row-3";
    tempRow.style.gridTemplateColumns = "repeat(3, 110px)";
    tempRow.style.marginTop = "15px";

    top3Cards.forEach(card => {
      const clonedCard = card.cloneNode(true);
      tempRow.appendChild(clonedCard);
    });

    tempContainer.appendChild(tempRow);
  });

  html2canvas(tempContainer, { scale: 2 }).then(canvas => {
    const pdf = new jsPDF('l', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();
    const imgWidth = pdfWidth;
    const imgHeight = canvas.height * imgWidth / canvas.width;
    let heightLeft = imgHeight;
    let offsetY = 0;
    const ratio = imgWidth / canvas.width;

    while (heightLeft > 0) {
      const pageHeightInPdf = Math.min(pdfHeight, heightLeft);
      const srcHeight = pageHeightInPdf / ratio;

      const pageCanvas = document.createElement('canvas');
      pageCanvas.width = canvas.width;
      pageCanvas.height = srcHeight;
      const ctx = pageCanvas.getContext('2d');
      ctx.drawImage(canvas, 0, offsetY, canvas.width, srcHeight, 0, 0, canvas.width, srcHeight);

      const pageImgData = pageCanvas.toDataURL('image/png');
      pdf.addImage(pageImgData, 'PNG', 0, 0, imgWidth, pageHeightInPdf);

      offsetY += srcHeight;
      heightLeft -= pageHeightInPdf;

      if (heightLeft > 0) {
        pdf.addPage();
      }
    }

    pdf.save(fileName);
    document.body.removeChild(tempContainer);
  });
}

renderCards();
</script>

</body>
</html>